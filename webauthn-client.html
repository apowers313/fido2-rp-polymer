<link rel="import" href="bower_components/polymer/polymer.html">
<script src="bower_components/swagger-js/browser/swagger-client.js"></script>
<!--
`webauthn-client`
A relying party application for FIDO 2.0 / WebAuthn

@demo demo/index.html
-->
<dom-module id="webauthn-client">
    <template>
        <style>
        :host {
            display: block;
        }
        </style>
        <h2>Host [[serverUrl]]</h2>
        <h2>Port [[serverPort]]</h2>
    </template>
    <script>
    Polymer({

        is: 'webauthn-client',

        properties: {
            // the full URL for the swagger.json file
            swaggerUrl: {
                type: String
            },

            // The hostname:port for the FIDO server
            serverUrl: {
                type: String,
                observer: "_serverUrlChanged"
            },

            // The hostname for the FIDO server, parsed from serverUrl
            serverHost: String,

            // The port for the FIDO server, parsed from serverUrl
            serverPort: {
                type: Number,
                value: 0xF1D0,
            },
            // CONFIG:

            // server basepath
            // register-challenge path
            // register path
            // auth-challenge path
            // auth path
        },

        _serverUrlChanged: function(serverUrl) {
            console.log("serverUrl changed: " + serverUrl);
            var regexpStr =
                "(?:http[s]?:\/\/)" + // if the string starts with http:// or https:// ignore that part
                "?([^:\/\s]+)" + // gather up the part up to the next "/" or ":", that's the hostname
                "(?::([0-9]+))?"; // if there's a ":number" part, grab the number for the port
            var regex = new RegExp(regexpStr);
            var str = "http://webauthn.org:80/";
            var match = regex.exec(str);
            var hostname = match[1];
            var port = match[2];
            console.log("host: " + hostname);
            console.log("port: " + port);
            if (hostname) this.serverHost = hostname;
            if (port) this.serverPort = port;
        },

        attached: function() {
            // TODO: validate config
            console.log("attached: " + this.localName + '#' + this.id);
            console.log("SwaggerClient:", SwaggerClient);

            this._swaggerClient = new SwaggerClient({
                    url: 'http://localhost:61904/api/authn/fido/v1/swagger',
                    usePromise: true
                })
                .then((client) => {
                    // this._swaggerClient.pet.getPetById({
                    //     petId: 7
                    // }, {
                    //     responseContentType: 'application/json'
                    // }, function(pet) {
                    //     console.log('pet', pet);
                    // });
                    console.log("success setting up swagger client");
                    console.log("_swaggerClient:", this._swaggerClient);
                    this._client = client;
                    console.log("client:", client);
                    this.register("adam");
                })
                .catch((err) => {
                    console.log(err);
                });
        },

        // create a new account on the FIDO server
        register: function(userId) {
            console.log("register");
            console.log(`doing register for ${userId}...`);
            var msg = {
                "header": {
                    "op": "Reg",
                    "version": {
                        "major": 2,
                        "minor": 0
                    },
                    "appID": "string",
                    "serverData": "string"
                },
                "userId": userId
            };
            this._client.register.register({msg: msg})
                .then((resp) => {
                    console.log ("Got response:", resp);
                    // return makeCredential (resp.obj.challenge)
                });
        },

        // login to an existing account on the FIDO server
        authn: function(userId) {
            console.log(`doing authn for ${userId}...`);
        }

        // grab swagger JSON
        // fire webauth-client-ready

        /* JSHINT */
        /* globals SwaggerClient */
    });
    </script>
</dom-module>
